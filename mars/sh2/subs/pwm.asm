; ==================================================================
; ---------------------------------------------------
; PWM
; ---------------------------------------------------

; ---------------------------------------------------
; Variables
; ---------------------------------------------------

		rsreset
chn_read	rs.l 1
chn_loop	rs.l 1			;-1 = dont loop
chn_end		rs.l 1
chn_flags	rs.l 1
chn_note	rs.l 1
chn_pitch	rs.l 1
chn_pan		rs.l 1			;%000000LR
chn_vol		rs.l 1
chn_wav		rs.l 1
chn_timer	rs.l 1
chn_smplid	rs.l 1
sizeof_chn	rs.l 0

		rsreset
smpl_start	rs.l 1
smpl_end	rs.l 1
smpl_loop	rs.l 1
smpl_pitch	rs.l 1
smpl_pan	rs.l 1
smpl_vol	rs.l 1
smpl_null	rs.l 1
sizeof_list	rs.l 0

maxsmpl		equ	32
maxchnls	equ	8

; chn_flags
bitOn		equ	%00000001

; chn_pan
bitLeft		equ	%00000010
bitRight	equ	%00000001

; ---------------------------------------------------
; Data
; ---------------------------------------------------

		cnop 0,4
pitch_table:
           	dc.b $00,$00,$00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00 ; C-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; C#0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D#0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; E-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F#0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G#0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; A-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; A#0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; B-0 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
; ------------------------------

           	dc.b $00,$00,$00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00 ; C-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; C#1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D#1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; E-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F#1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G#1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; A-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; A#1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; B-1 (NULL)
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
; ------------------------------

           	dc.b $00,$00,$00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00 ; C-2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00,$00,$FF,$00 ; C#2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D-2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

    		dc.b $00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00,$FF,$00,$00,$00 ; D#2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $00,$00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00,$01,$00,$00,$00 ; E-2
    		dc.b $00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F-2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
           	dc.b $00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$01,$00,$00,$00,$00,$00 ; F#2
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $00,$00,$00,$00,$00,$01,$00,$00,$00,$00,$01,$00,$00,$00,$00,$FF ; G-2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
          	dc.b $00,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G#2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		
    		dc.b $00,$00,$00,$00,$01,$00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00 ; A-2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $00,$00,$00,$01,$00,$00,$00,$01,$00,$00,$00,$00,$FF,$00,$00,$00 ; A#2
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

    		dc.b $00,$00,$00,$01,$00,$00,$00,$01,$00,$00,$00,$00,$01,$00,$00,$00 ; B-2
    		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
; ------------------------------

           	dc.b $00,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; C-3	;4000
    		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
 
           	dc.b $00,$00,$00,$01,$00,$00,$00,$01,$00,$00,$01,$00,$00,$00,$FF,$00 ; C#3
   		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
		
           	dc.b $00,$00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$00,$00,$FF,$00,$00 ; D-3
   		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  
           	dc.b $00,$00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$00,$00,$01,$00,$00 ; D#3
   		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  		
           	dc.b $00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$00,$01,$00 ; E-3
   		dc.b $00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
 
           	dc.b $00,$00,$01,$00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F-3
   		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  		
             	dc.b $00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$FF,$00,$00 ; F#3
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  
             	dc.b $00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$01,$00,$FF ; G-3
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  		
             	dc.b $00,$00,$01,$00,$00,$01,$00,$00,$01,$00,$01,$00,$00,$01,$FF,$00 ; G#3
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

             	dc.b $00,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$00,$01 ; A-3
		dc.b $00,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
  		
             	dc.b $00,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$00,$01 ; A#3
		dc.b $00,$00,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

             	dc.b $00,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$00,$01 ; B-3
		dc.b $01,$00,$01,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

; ------------------------------

        	dc.b $00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; C-4	;8000
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
   		
     		dc.b $01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$01,$00,$FF,$00,$00,$00 ; C#4
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
     		dc.b $01,$00,$01,$00,$01,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D-4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
     		dc.b $01,$00,$01,$00,$01,$00,$01,$00,$01,$FF,$00,$00,$00,$00,$00,$00 ; D#4
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $01,$00,$01,$00,$01,$00,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00 ; E-4 
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
    		dc.b $01,$00,$01,$00,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F-4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
   		dc.b $01,$00,$01,$00,$01,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F#4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
 		dc.b $01,$01,$00,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G-4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

  		dc.b $01,$00,$01,$01,$01,$01,$00,$01,$01,$FF,$00,$00,$00,$00,$00,$00 ; G#4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
  		dc.b $01,$00,$01,$01,$01,$01,$00,$01,$01,$01,$01,$01,$FF,$00,$00,$00 ; A-4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
 		dc.b $01,$01,$01,$01,$01,$01,$01,$01,$00,$FF,$00,$00,$00,$00,$00,$00 ; A#4
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

 		dc.b $01,$01,$01,$01,$01,$01,$01,$01,$00,$01,$01,$01,$01,$01,$01,$01 ; B-4
     		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
    		
; ------------------------------

 		dc.b $FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; C-5	;16000
     		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

 		dc.b $02,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$FF ; C#5
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
     		
 		dc.b $02,$01,$01,$01,$01,$01,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00 ; D-5
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
     		
 		dc.b $02,$01,$01,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; D#5
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
     		
 		dc.b $02,$01,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; E-5 ???
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

 		dc.b $02,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F-5
      		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

 		dc.b $02,$02,$01,$01,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; F#5
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

		dc.b $02,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00 ; G-5
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

		dc.b $02,$01,$02,$01,$02,$02,$01,$02,$02,$FF,$00,$00,$00,$00,$00,$00 ; G#5
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
       		
		dc.b $02,$01,$02,$01,$02,$02,$02,$02,$02,$01,$02,$02,$01,$02,$FF,$00 ; A-5
		dc.b $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

		dc.b $02,$01,$02,$01,$02,$02,$02,$02,$02,$01,$02,$02,$01,$02,$02,$02 ; A#5
		dc.b $02,$02,$02,$02,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

		dc.b $02,$02,$02,$02,$02,$02,$01,$02,$02,$02,$02,$02,$02,$02,$02,$02 ; B-5
		dc.b $02,$02,$02,$02,$FF,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
        	
; ------------------------------

		dc.b $03,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02 ; C-6
		dc.b $02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$FF

 		dc.b $03,$02,$02,$02,$02,$03,$02,$02,$02,$02,$03,$02,$02,$02,$03,$02 ; C#6
		dc.b $02,$02,$02,$03,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$02,$FF
     		
 		dc.b $03,$02,$02,$02,$02,$03,$02,$02,$02,$02,$03,$02,$03,$02,$03,$02 ; D-6
		dc.b $02,$02,$02,$03,$02,$03,$02,$02,$03,$02,$02,$02,$02,$03,$02,$FF
     		
 		dc.b $03,$02,$02,$03,$02,$03,$02,$03,$02,$02,$03,$02,$03,$02,$03,$02 ; D#6
		dc.b $02,$03,$02,$03,$02,$03,$02,$02,$03,$02,$03,$02,$02,$03,$02,$FF
     		
 		dc.b $03,$03,$02,$03,$03,$03,$02,$03,$02,$02,$03,$02,$03,$02,$03,$02 ; E-6
		dc.b $02,$03,$02,$03,$02,$03,$03,$03,$03,$02,$03,$02,$03,$03,$02,$FF

 		dc.b $03,$03,$02,$03,$03,$03,$03,$03,$02,$03,$03,$02,$03,$02,$03,$03 ; F-6
		dc.b $02,$03,$02,$03,$03,$03,$03,$03,$03,$02,$03,$02,$03,$03,$02,$FF

 		dc.b $03,$03,$02,$03,$03,$03,$03,$03,$02,$03,$03,$02,$03,$03,$03,$03 ; F#6
		dc.b $03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$FF

 		dc.b $04,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03 ; G-6
		dc.b $03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$FF

 		dc.b $04,$03,$03,$03,$04,$03,$03,$03,$03,$03,$04,$03,$03,$03,$04,$03 ; G#6
		dc.b $04,$03,$03,$04,$03,$03,$03,$04,$03,$03,$03,$03,$03,$04,$03,$FF
       		
 		dc.b $04,$03,$03,$04,$04,$03,$04,$03,$04,$03,$04,$03,$04,$03,$04,$03 ; A-6
		dc.b $04,$03,$03,$04,$03,$03,$03,$04,$03,$03,$04,$03,$03,$04,$03,$FF

 		dc.b $04,$03,$03,$04,$04,$03,$04,$04,$04,$03,$04,$03,$04,$04,$04,$03 ; A#6
		dc.b $04,$04,$03,$04,$04,$03,$03,$04,$03,$04,$04,$03,$03,$04,$03,$FF

 		dc.b $04,$03,$04,$04,$04,$04,$04,$04,$04,$03,$04,$03,$04,$04,$04,$04 ; B-6
		dc.b $04,$04,$04,$04,$04,$04,$04,$04,$03,$04,$04,$04,$04,$04,$03,$FF
		
; ------------------------------

 		dc.b $05,$05,$05,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04 ; C-7
		dc.b $04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$04,$FF

 		dc.b $05,$05,$05,$04,$04,$05,$04,$04,$05,$04,$04,$05,$04,$04,$04,$05 ; C#7
		dc.b $04,$04,$05,$04,$04,$05,$04,$04,$04,$04,$04,$04,$04,$04,$04,$FF
     		
 		dc.b $05,$05,$05,$04,$05,$05,$04,$05,$05,$04,$05,$05,$04,$05,$04,$05 ; D-7
		dc.b $05,$04,$05,$04,$04,$05,$05,$04,$04,$05,$04,$04,$05,$04,$05,$FF
     		
 		dc.b $03,$02,$02,$03,$02,$03,$02,$03,$02,$02,$03,$02,$03,$02,$03,$02 ; D#7		;TODO: later
		dc.b $02,$03,$02,$03,$02,$03,$02,$02,$03,$02,$03,$02,$02,$03,$02,$FF
     		
 		dc.b $03,$03,$02,$03,$03,$03,$02,$03,$02,$02,$03,$02,$03,$02,$03,$02 ; E-7
		dc.b $02,$03,$02,$03,$02,$03,$03,$03,$03,$02,$03,$02,$03,$03,$02,$FF

 		dc.b $03,$03,$02,$03,$03,$03,$03,$03,$02,$03,$03,$02,$03,$02,$03,$03 ; F-7
		dc.b $02,$03,$02,$03,$03,$03,$03,$03,$03,$02,$03,$02,$03,$03,$02,$FF

 		dc.b $03,$03,$02,$03,$03,$03,$03,$03,$02,$03,$03,$02,$03,$03,$03,$03 ; F#7
		dc.b $03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$FF

 		dc.b $04,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03 ; G-7
		dc.b $03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$FF

 		dc.b $04,$03,$03,$03,$04,$03,$03,$03,$03,$03,$04,$03,$03,$03,$04,$03 ; G#7
		dc.b $04,$03,$03,$04,$03,$03,$03,$04,$03,$03,$03,$03,$03,$04,$03,$FF
       		
 		dc.b $04,$03,$03,$04,$04,$03,$04,$03,$04,$03,$04,$03,$04,$03,$04,$03 ; A-7
		dc.b $04,$03,$03,$04,$03,$03,$03,$04,$03,$03,$04,$03,$03,$04,$03,$FF

 		dc.b $04,$03,$03,$04,$04,$03,$04,$04,$04,$03,$04,$03,$04,$04,$04,$03 ; A#7
		dc.b $04,$04,$03,$04,$04,$03,$03,$04,$03,$04,$04,$03,$03,$04,$03,$FF

 		dc.b $04,$03,$04,$04,$04,$04,$04,$04,$04,$03,$04,$03,$04,$04,$04,$04 ; B-7
		dc.b $04,$04,$04,$04,$04,$04,$04,$04,$03,$04,$04,$04,$04,$04,$03,$FF
		cnop 0,4
		
; ---------------------------------------------------
; pwm_init
;
; Inits pwm, also turns ON the pwm interrupt
;
; Uses:
; r0
; ---------------------------------------------------

pwm_init:		
		mov.l	#((((23011361<<1)/16000+1)>>1)+1),r0
		mov.w	r0,@(cycle,gbr)
		mov.l	#$0105,r0
		mov.w	r0,@(timerctl,gbr)
  		
		mov	#1,r0
		mov.w	r0,@(monowidth,gbr)
		mov.w	r0,@(monowidth,gbr)
		mov.w	r0,@(monowidth,gbr)
		
		rts
		nop
		cnop 0,4
		lits

; ---------------------------------------------------
; pwm_setentry
;
; Sets a new entry to the pwm list
;
; Input:
; r1 - Start
; r2 - End
; r3 - Loop, -1 dont loop
; r4 - Note transpose
; r5 - Instrument slot
; ---------------------------------------------------

pwm_setentry:
 		mov.l	#pwm_samplelist,r8
  		mov	#sizeof_list,r0
  		mulu	r5,r0
  		mov	macl,r0
  		add 	r0,r8
  
 		mov.l	r1,(smpl_start,r8)
 		mov.l	r2,(smpl_end,r8)
 		mov.l	r3,(smpl_loop,r8)
 		mov.l	r4,(smpl_pitch,r8)
		rts
		nop
		cnop 0,4
		lits

; ---------------------------------------------------
; pwm_setsmpl
;
; Plays a Channel
;
; Input:
; r1 - Channel
; r2 - Sample to use
; ---------------------------------------------------

pwm_setvol:
 		mov.l	#pwm_channels,r8
  		mov	#sizeof_chn,r0
  		mulu	r1,r0
  		mov	macl,r0
  		add 	r0,r8
  		
 		mov.l	r2,(chn_vol,r8)
		rts
		nop
		cnop 0,4
		lits
		
; ---------------------------------------------------
; pwm_setsmpl
;
; Plays a Channel
;
; Input:
; r1 - Channel
; r2 - Sample to use
; ---------------------------------------------------

pwm_setsmpl:
 		mov.l	#pwm_samplelist,r7
  		mov	#sizeof_list,r0
  		mulu	r2,r0
  		mov	macl,r0
  		add 	r0,r7
 		mov.l	#pwm_channels,r8
  		mov	#sizeof_chn,r0
  		mulu	r1,r0
  		mov	macl,r0
  		add 	r0,r8
 		mov.l	r2,(chn_smplid,r8)
 		
 		mov.l	#0,r0
 		mov.l	r0,(chn_flags,r8)
 		mov.l	r0,(chn_timer,r8)
 		
 		mov.l	@(smpl_start,r7),r0
 		mov.l	r0,@(chn_read,r8)
 		mov.l	@(smpl_end,r7),r0
 		mov.l	r0,@(chn_end,r8)		
 		mov.l	@(smpl_loop,r7),r0
 		mov.l	r0,@(chn_loop,r8)
  		mov.l	@(smpl_pitch,r7),r0
  		mov.l	r0,@(chn_pitch,r8)
		rts
		nop
		cnop 0,4
		lits
  		
; ---------------------------------------------------
; pwm_play
;
; Plays a Channel
;
; Input:
; r1 - Channel
; r2 - Note
; r3 - Panning
; ---------------------------------------------------

pwm_play:
 		mov.l	#pwm_channels,r8
  		mov	#sizeof_chn,r0
  		mulu	r1,r0
  		mov	macl,r0
  		add 	r0,r8
 		mov.l	r2,(chn_note,r8)
  		mov.l	r3,(chn_pan,r8)

  		mov.l	@(chn_smplid,r8),r2
 		mov.l	#pwm_samplelist,r7
  		mov	#sizeof_list,r0
  		mulu	r2,r0
  		mov	macl,r0
  		add 	r0,r7
 		mov.l	@(smpl_start,r7),r0
 		mov.l	r0,@(chn_read,r8)
 		mov.l	@(smpl_end,r7),r0
 		mov.l	r0,@(chn_end,r8)		
 		mov.l	@(smpl_loop,r7),r0
 		mov.l	r0,@(chn_loop,r8)
  		mov.l	@(smpl_pitch,r7),r0
  		mov.l	r0,@(chn_pitch,r8)

 		mov.l	#0,r0
 		mov.l	r0,(chn_timer,r8)
 		mov.l	#1,r0
 		mov.l	r0,(chn_flags,r8)
		rts
		nop
		cnop 0,4
		lits
		
; ---------------------------------------------------
; pwm_stop
;
; Stop a Channel
;
; Input:
; r1 - Channel
; ---------------------------------------------------

pwm_stop:
 		mov.l	#pwm_channels,r8
  		mov	#sizeof_chn,r0
  		mulu	r1,r0
  		mov	macl,r0
  		add 	r0,r8

 		mov.l	#0,r0
 		mov.l	r0,(chn_timer,r8)
 		mov.l	r0,(chn_flags,r8)
		rts
		nop
		cnop 0,4
		lits
		
; ---------------------------------------------------
; pwm_run
;
; Reads pwm
;
; Uses:
; r0-r8
; ---------------------------------------------------

pwm_run:
 		mov.l	#pwm_channels,r8
 		mov.l	#maxchnls,r7
 		
@next:
		mov.l	#$7F,r0
 		mov.l	r0,@(chn_wav,r8)
 		mov.l	@(chn_flags,r8),r0
 		cmp/eq	#0,r0
 		bt	@off
 		
 		mov.l	@(chn_read,r8),r1
 		mov.b	@r1,r0
     		and	#$FF,r0
      		mov	r0,r2

		mov	@(chn_vol,r8),r3
; 		mov	#0,r4
; 		cmp/eq	r4,r3
; 		bt 	@ignore_vol
 		mulu	r3,r2
		mov	macl,r2
		shlr2	r2
		shlr2	r2
      		sub 	r2,r0
      		cmp/pl	r0
      		bf	@zero
      		
      		and	#$FF,r0
     		bra	@ignore_vol
     		nop
@zero:
     		mov	#0,r0
     		bra	@ignore_vol
     		nop
     		
      		mov 	#0,r2
      		mov 	r0,r2
      		shlr2	r2
      		shlr 	r2
      		mov	@(chn_vol,r8),r3
      		mulu 	r3,r2
      		mov 	macl,r2
      		sub 	r2,r0
      		and	#$FF,r0
    		
    		tst	#$80,r0
     		bf	@pwm_1
     		mov.l	#$80,r2
     		sub	r0,r2
      		mov.l	@(chn_vol,r8),r0
     		mulu	r0,r2
     		sts	macl,r0
     		mov.l	#$80,r2
     		sub	r0,r2
     		mov	r2,r0
     		bra	@pwm_2
    		nop
@pwm_1:
     		mov.l	#$80,r2
     		sub	r2,r0
      		mov.l	@(chn_vol,r8),r2
     		mulu	r0,r2
     		sts	macl,r0
     		mov.l	#$80,r2
     		add	r2,r0
@pwm_2:
     		cmp/eq	#0,r0
     		bf	@pwm_3
    		add	#1,r0
@pwm_3:

@ignore_vol:
   		mov.l	r0,@(chn_wav,r8)

  		mov.l	#pitch_table,r3
  		mov.l	@(chn_note,r8),r0
    		mov.l	@(chn_pitch,r8),r4
    		add	r4,r0
  		shll2	r0
  		shll2	r0
  		shll	r0			;list size: $20
  		add 	r0,r3
  		mov.l	@(chn_timer,r8),r2
    		add	r2,r3
 		mov.l	#0,r0
  		mov.b	@r3,r0
  		add	#1,r2
 		cmp/eq	#$FF,r0
  		bf	@true
 		mov	#1,r0
  		mov	#0,r2
@true:
 		mov.l	r2,@(chn_timer,r8)
 		add.l	r0,r1
 		
 		mov.l	@(chn_end,r8),r2
 		cmp/ge	r2,r1
 		bf	@keep
		
 		mov.l	#-1,r3
   		mov.l	@(chn_loop,r8),r1
   		cmp/eq	r3,r1
   		bf	@keep
 		mov.l	#$7F,r0
  		mov.l	r0,@(chn_wav,r8)
 		mov.l	#0,r0
  		mov.l	r0,@(chn_flags,r8)
	
@keep:
 		mov.l	r1,@(chn_read,r8)
 		
@off:
		add	#sizeof_chn,r8
 		dt	r7
 		bf	@next

; ----------------------------------
; Send WAV to PWM
; ----------------------------------
 
 		mov.l	#pwm_channels,r8
  		mov.l	#maxchnls,r7
  		mov.l	#0,r5
  		mov.l	#0,r6
@next_wav:
 		mov.l	@(chn_wav,r8),r1
 		mov.l	@(chn_pan,r8),r0
 		tst	#bitRight,r0
 		bt	@not_l
 		add	r1,r6
@not_l:
 		tst	#bitLeft,r0
 		bt	@off_wav
 		add	r1,r5
@off_wav:
  		add.l	#sizeof_chn,r8
 		dt	r7
 		bf	@next_wav
 		
; ----------------------------------
 
@tryagain:
 		mov.l	r5,r0
 		mov.w	r0,@(lchwidth,gbr)
 		mov.l	r6,r0
 		mov.w	r0,@(rchwidth,gbr)
 		
  		mov.w	@(monowidth,gbr),r0
  		shlr8	r0
 		tst	#$80,r0
 		bt	@tryagain
	
		rts
		nop
		cnop 0,4
		lits
